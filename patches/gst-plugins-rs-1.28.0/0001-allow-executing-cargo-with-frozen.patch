From: Michael Olbrich <m.olbrich@pengutronix.de>
Date: Tue, 25 Apr 2023 17:43:16 +0200
Subject: [PATCH] allow executing cargo with --frozen

Signed-off-by: Michael Olbrich <m.olbrich@pengutronix.de>
---
 cargo_wrapper.py  | 4 ++++
 meson.build       | 4 ++++
 meson_options.txt | 2 ++
 3 files changed, 10 insertions(+)

diff --git a/cargo_wrapper.py b/cargo_wrapper.py
index b62ed4278605..97d801907ea4 100755
--- a/cargo_wrapper.py
+++ b/cargo_wrapper.py
@@ -34,6 +34,7 @@ PARSER.add_argument('--depfile', type=P)
 PARSER.add_argument('--target-dir', type=P, default=None)
 PARSER.add_argument('--disable-doc', action='store_true', default=False)
 PARSER.add_argument('--build-tests', action='store_true', default=False)
+PARSER.add_argument('--frozen', action="store_true", default=False)
 
 
 def shlex_join(args):
@@ -284,6 +285,9 @@ if __name__ == '__main__':
         print('Unknown command:', opts.command, file=logfile)
         sys.exit(1)
 
+    if opts.frozen:
+        cargo_cmd += ['--frozen']
+
     if rustc_target:
         cargo_cmd += ['--target', rustc_target]
     if features:
diff --git a/meson.build b/meson.build
index 50ac870fe5f9..d7299aa034c3 100644
--- a/meson.build
+++ b/meson.build
@@ -649,6 +649,10 @@ if get_option('doc').disabled()
   extra_args += ['--disable-doc']
 endif
 
+if get_option('frozen')
+  extra_args += ['--frozen']
+endif
+
 # 'pkgconfig' is the entry in the machine file, if specified
 pkg_config = find_program('pkgconfig', 'pkg-config')
 if pkg_config.found()
diff --git a/meson_options.txt b/meson_options.txt
index 55cfc13173f2..645b2e67d05e 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -89,3 +89,5 @@ option('tests', type : 'feature', value : 'auto', yield : true,
        description : 'Build and enable unit tests')
 option('auto_plugin_features', type: 'feature', value: 'auto',
        description: 'Override value of all auto plugin features')
+option('frozen', type: 'boolean', value: false,
+       description: 'Run cargo with --frozen')
